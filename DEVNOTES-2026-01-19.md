# terminalSynth Development Notes - 2026-01-19

## Session Summary

This session added several new features to terminalSynth.c, transforming it from a basic keyboard-to-MIDI synthesizer into a more full-featured instrument with channel switching, tempo control, and a metronome.

## Features Added

### 1. Auto-Repeat Program Change (`[` / `]`)
- Holding bracket keys now continuously increments/decrements the MIDI program
- 0.3s initial delay, then 0.1s repeat interval
- Implemented using CFRunLoopTimer

### 2. Metronome (`TAB`)
- Toggle on/off with TAB key
- Plays hi wood block (note 76) on MIDI drum channel (channel 10)
- Default tempo: 120 BPM
- Uses one-shot timers that reschedule themselves, allowing smooth tempo changes

### 3. MIDI Channel Switching (`Shift` + `-`/`=`)
- 16 MIDI channels available (1-16)
- Each channel remembers its own program selection (`channelPrograms[16]` array)
- Auto-repeat while held (same mechanism as program change)
- Sends note-off messages for all held notes when switching channels

### 4. Tempo Control (`-` / `=`)
- Adjusts metronome BPM (range: 20-300)
- Auto-repeat while held
- Updates take effect on next metronome beat without retriggering

### 5. Held Note Tracking
- `heldNoteChannel[128]` array tracks which channel each note is playing on
- Note-off messages sent to original channel, not current channel
- `all_notes_off()` function silences all held notes (called on channel change)

### 6. Terminal Input Fix
- Added `tcflush(STDIN_FILENO, TCIFLUSH)` in `restore_terminal()`
- Prevents buffered keypresses from printing when program exits

## Key Bindings (Final)

| Key | Function |
|-----|----------|
| `z x c v b n m` | Play notes (MIDI 36-42) |
| `a s d f g h j k l` | Play notes (MIDI 43-51) |
| `q w e r t y u i o p` | Play notes (MIDI 52-61) |
| `[` / `]` | Change program (0-127, hold to repeat) |
| `-` / `=` | Change tempo (hold to repeat) |
| `Shift` + `-`/`=` | Change MIDI channel (1-16, hold to repeat) |
| `TAB` | Toggle metronome |
| `ESC` | Quit |

## New Global State Variables

```c
static int channelPrograms[16] = {0};      // Per-channel program memory
static int currentChannel = 0;              // Active MIDI channel
static int8_t heldNoteChannel[128];         // Note-to-channel mapping (-1 = not held)
static bool shiftHeld = false;              // Shift key state
static int metronomeBPM = 120;              // Metronome tempo
static bool metronomeEnabled = false;       // Metronome state
static CFRunLoopTimerRef metronomeTimer;    // Metronome timer
static CFRunLoopTimerRef programChangeTimer;
static CFRunLoopTimerRef channelChangeTimer;
static CFRunLoopTimerRef tempoChangeTimer;
```

## New Functions

- `all_notes_off()` - Send note-off for all held notes
- `channel_change()` - Switch MIDI channel with note cleanup
- `start/stop_channel_change_timer()` - Auto-repeat for channel switching
- `tempo_change()` - Adjust metronome BPM
- `start/stop_tempo_change_timer()` - Auto-repeat for tempo adjustment
- `toggle_metronome()` - Start/stop metronome
- `metronome_tick()` - Play metronome sound and reschedule
- `schedule_next_metronome_tick()` - One-shot timer scheduling

## Files Modified

- `terminalSynth.c` - All feature additions
- `CLAUDE.md` - Updated documentation with new controls and functions
